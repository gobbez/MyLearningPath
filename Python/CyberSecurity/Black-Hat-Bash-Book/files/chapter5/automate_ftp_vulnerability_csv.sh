#!/bin/bash

INPUT_FILE=$1  # File containing list of IPs or hostnames
OUTPUT_FILE="results.csv"

# Check if input file exists
if [ ! -f "$INPUT_FILE" ]; then
    echo "Usage: $0 host_list.txt"
    exit 1
fi

# Write CSV headers
echo "Host,FTP Port Status,Anonymous FTP,Timestamp" > "$OUTPUT_FILE"

# Loop through each host
while read -r HOST; do
    echo "[+] Scanning $HOST"

    TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
    FTP_STATUS="closed"
    ANON_FTP="unknown"

    # Check if the host is reachable
    if ping -c 1 -W 1 "$HOST" &> /dev/null; then
        echo "  - $HOST is up"

        # Check if port 21 is open
        if nmap -p 21 --open "$HOST" | grep -q "21/tcp open"; then
            FTP_STATUS="open"
            echo "  - FTP port is open"

            # Scan with nuclei (optional output parsing)
            nuclei -u "$HOST" -tags ftp

            # Scan with Nmap NSE to detect anonymous login
            NMAP_OUTPUT=$(nmap -p 21 --script ftp-anon.nse "$HOST")

            if echo "$NMAP_OUTPUT" | grep -q "Anonymous FTP login allowed"; then
                ANON_FTP="yes"
                echo "  - Anonymous FTP login allowed"
            else
                ANON_FTP="no"
                echo "  - Anonymous FTP not allowed"
            fi
        else
            echo "  - FTP port is closed"
        fi
    else
        echo "  - $HOST is down or unreachable"
        FTP_STATUS="unreachable"
        ANON_FTP="n/a"
    fi

    # Append result to CSV
    echo "$HOST,$FTP_STATUS,$ANON_FTP,$TIMESTAMP" >> "$OUTPUT_FILE"

done < "$INPUT_FILE"

echo "[âœ“] Results saved in $OUTPUT_FILE"
